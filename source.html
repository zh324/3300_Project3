<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - geometry - catmull spline editor</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #f0f0f0;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				position: absolute;
				top: 0px;
				width: 100%;
				padding: 5px;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
			}
		</style>
	</head>
	<body>
		<div id="container" width="2000" height="2000"></div>

		<script src="three.js-master/build/three.js"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>

		<script src="js/DragControls.js"></script>
		<script src="js/OrbitControls.js"></script>
		<script src="js/TransformControls.js"></script>

		<script src="js/stats.min.js"></script>
		<script src="js/dat.gui.min.js"></script>
		<script>
			var hotelData;
			var restaurantData;
			var entertainmentData;
			var buildingObjects = [];
			var positions = [];
			var objectCount = 0;
			var projection = d3.geoMercator()

			//to alignment the coordinate plane
			var xOffset = -1000;
			var yOffset = -7000;
			var scaleFactor = 10000;
			var angle = 33;
			var minX, minY, maxX, maxY;

			var hiding;

			//control
			var container, stats;
			var camera, scene, renderer, raycaster;
			var mouse = new THREE.Vector2(), INTERSECTED;
			var point = new THREE.Vector3();
			var geometry = new THREE.BoxBufferGeometry( 50, 100, 50 );
			var transformControl;
			var ARC_SEGMENTS = 200;
			var splines = {};
			var params = {
				restaurant: {
					include: true,
					price: 100,
					category: {
						chinese: true,
						korean: true,
						american: true,
						indian: true,
						italian: true
					}
				},
				hotel: {
					include: true,
					price: 100,
					category: {
						holiday: true,
						business: true
					}
				},
				entertainment: {
					include: true,
					price: 100,
					category: {
						movie: true,
						game: true,
						shopping: true
					}
				}
			};

			//load csv file
			d3.queue()
			.defer(d3.csv, "data/hotels.csv")
			.defer(d3.csv, "data/restaurants.csv")
			.defer(d3.csv, "data/entertainment.csv")
			.await(function(error, data1, data2, data3) {
				if (error) {
					console.error('Oh dear, something went wrong: ' + error);
				}
				else {
					hotelData = data1;
					restaurantData = data2;
					entertainmentData = data3;

					assignCoordinate(hotelData);
					assignCoordinate(restaurantData);
					assignCoordinate(entertainmentData);

					maxX = d3.max(hotelData.map(function(d){return d.coordinate[0];}));
					minX = d3.min(hotelData.map(function(d){return d.coordinate[0];}));
					maxY = d3.max(hotelData.map(function(d){return d.coordinate[1];}));
					minY = d3.min(hotelData.map(function(d){return d.coordinate[1];}));

					scaleData(restaurantData);
					scaleData(hotelData);
					scaleData(entertainmentData);

				}

				init();
				plot();
				animate();

				// function onMouseMove( event ) { 
				// // calculate mouse position in normalized device coordinates 
				// // (-1 to +1) for both components 
				// mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1; 
				// mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1; 
				// } 

				// window.addEventListener( 'mousemove', onMouseMove, false );
				// window.requestAnimationFrame(render);
			});

			function init() {
				container = document.getElementById( 'container' );
				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xf0f0f0 );
				camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.1, 100000 );
				camera.position.set( 0, 250, 1000 );
				scene.add( camera );
				scene.add( new THREE.AmbientLight( 0xf0f0f0 ) );

				// add raycaster
				raycaster = new THREE.Raycaster();

				addLightShadow();
				createGUI();

				var planeGeometry = new THREE.PlaneBufferGeometry( 15000, 7000 );
				planeGeometry.rotateX( - Math.PI / 2 );
				var planeMaterial = new THREE.ShadowMaterial( { opacity: 0.2 } );

				//add plane
				var plane = new THREE.Mesh( planeGeometry, planeMaterial );
				plane.position.y = -200;
				plane.receiveShadow = true;
				scene.add( plane );

				//grid helper
				// var helper = new THREE.GridHelper( 15000, 100 );
				// helper.position.y = - 199;
				// helper.material.opacity = 0.25;
				// helper.material.transparent = true;
				// scene.add( helper );

				//render
				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMap.enabled = true;
				container.appendChild( renderer.domElement );
				
				//stats
				stats = new Stats();
				container.appendChild( stats.dom );

				// Controls
				var controls = new THREE.OrbitControls( camera, renderer.domElement );
			}


			function animate() {
				requestAnimationFrame( animate );
				render();
				stats.update();
			}


			function render() {
				// update the picking ray with the camera and mouse position
				raycaster.setFromCamera( mouse, camera );
				// calculate objects intersecting the picking ray
				var intersects = raycaster.intersectObjects( scene.children );
				for ( var i = 0; i < intersects.length; i++ ) {
					intersects[ i ].object.material.color.set( 0x000000 );
				}
				renderer.render( scene, camera );				
			}


			function assignCoordinate(data) {
				for (var i = 0; i < data.length; i++) {
					var aa = [data[i].Latitude, data[i].Longitude];
					data[i].coordinate = projection(aa);
				}
			}


			function scaleData(data) {
				for (var i = 0; i < data.length; i++) {
					data[i].coordinate[0] = (data[i].coordinate[0] - minX) / (maxX - minX) * scaleFactor;
					data[i].coordinate[1] = (data[i].coordinate[1] - minY) / (maxY - minY) * scaleFactor;					
					var x = data[i].coordinate[0];
					var y = data[i].coordinate[1];
					var rad = angle * Math.PI/180;
					data[i].coordinate[0] = x * Math.cos(rad) - y * Math.sin(rad) + xOffset;
					data[i].coordinate[1] = y * Math.cos(rad) + x * Math.sin(rad) + yOffset;					
				}
			}


			function addLightShadow() {
				//light and shadow
				var light = new THREE.SpotLight( 0xffffff, 1.5 );
				light.position.set( 0, 1500, 200 );
				light.castShadow = true;
				light.shadow = new THREE.LightShadow( new THREE.PerspectiveCamera( 70, 1, 200, 2000 ) );
				light.shadow.bias = -0.000222;
				light.shadow.mapSize.width = 1024;
				light.shadow.mapSize.height = 1024;
				scene.add( light );
				spotlight = light;
			}


			function createGUI() {
				//GUI added
				var gui = new dat.GUI();
				var restaurant = gui.addFolder('Restaurants');
				restaurant.add(params.restaurant, 'include').onFinishChange(updatePlot);
				restaurant.add(params.restaurant, 'price', 0, 100).onFinishChange(updatePlot);
				var restaurantCategory = restaurant.addFolder('Restaurant category');
				restaurantCategory.add(params.restaurant.category, 'chinese').name('Chinese').onFinishChange(updatePlot);
				restaurantCategory.add(params.restaurant.category, 'korean').name('Korean').onFinishChange(updatePlot);
				restaurantCategory.add(params.restaurant.category, 'american').name('American').onFinishChange(updatePlot);
				restaurantCategory.add(params.restaurant.category, 'indian').name('Indian').onFinishChange(updatePlot);
				restaurantCategory.add(params.restaurant.category, 'italian').name('Italian').onFinishChange(updatePlot);
				restaurant.open();

				var hotel = gui.addFolder('Hotels');
				hotel.add(params.hotel, 'include').onFinishChange(updatePlot);
				hotel.add(params.hotel, 'price', 0, 100).onFinishChange(updatePlot);
				var hotelCategory = hotel.addFolder('Hotel category');
				hotelCategory.add(params.hotel.category, 'holiday').onFinishChange(updatePlot);
				hotelCategory.add(params.hotel.category, 'business').onFinishChange(updatePlot);
				hotel.open();

				var entertainment = gui.addFolder('Entertainment');
				entertainment.add(params.entertainment, 'include').onFinishChange(updatePlot);
				entertainment.add(params.entertainment, 'price', 0, 100).onFinishChange(updatePlot);
				var entertainmentCategory = entertainment.addFolder('Entertainment category');
				entertainmentCategory.add(params.entertainment.category, 'movie').onFinishChange(updatePlot);
				entertainmentCategory.add(params.entertainment.category, 'game').onFinishChange(updatePlot);
				entertainmentCategory.add(params.entertainment.category, 'shopping').onFinishChange(updatePlot);
				entertainment.open();
				gui.open();
			}


			function addSplineObject( position ) {
				var material = new THREE.MeshLambertMaterial( { color: Math.random() * 0xffffff } );
				var object = new THREE.Mesh( geometry, material );

				object.position.copy( position );

				object.castShadow = true;
				object.receiveShadow = true;
				scene.add( object );
				buildingObjects.push( object );
				return object;
			}


			function plot() {
				for (var i = 0; i < hotelData.length; i++) {
					var object = addSplineObject(new THREE.Vector3(hotelData[i].coordinate[0], -150, hotelData[i].coordinate[1]));
					objectCount++;
					positions.push(object.position);
				}
				for (var i = 0; i < restaurantData.length; i++) {
					var object = addSplineObject(new THREE.Vector3(restaurantData[i].coordinate[0], -150, restaurantData[i].coordinate[1]));
					objectCount++;
					positions.push(object.position);
				}
				for (var i = 0; i < entertainmentData.length; i++) {
					var object = addSplineObject(new THREE.Vector3(entertainmentData[i].coordinate[0], -150, entertainmentData[i].coordinate[1]));			
					objectCount++;
					positions.push(object.position);
				}					
			}


			function updatePlot() {
				removeAllPoints();
				if (params.hotel.include) {
					for (var i = 0; i < hotelData.length; i++) {
						var object = addSplineObject(new THREE.Vector3(hotelData[i].coordinate[0], -150, hotelData[i].coordinate[1]));
						objectCount++;
						positions.push(object.position);
					}
				}
				if (params.restaurant.include) {
					for (var i = 0; i < restaurantData.length; i++) {
						var object = addSplineObject(new THREE.Vector3(restaurantData[i].coordinate[0], -150, restaurantData[i].coordinate[1]));
						objectCount++;
						positions.push(object.position);
					}
				}
				if (params.entertainment.include) {
					for (var i = 0; i < entertainmentData.length; i++) {
						var object = addSplineObject(new THREE.Vector3(entertainmentData[i].coordinate[0], -150, entertainmentData[i].coordinate[1]));			
						objectCount++;
						positions.push(object.position);
					}	
				}				
			}


			function removeAllPoints() {
				if ( objectCount <= 0 ) {
					return;
				}
				for (var i = 0; i < objectCount; i++) {
					positions.pop();
					scene.remove( buildingObjects.pop() );
				}
				objectCount = 0;
			}
		</script>
	</body>
</html>